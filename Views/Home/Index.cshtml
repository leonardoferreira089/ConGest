@model ConGest.Controllers.CalendarViewModel
@{
    ViewData["Title"] = "Calendrier des congés";
}

<div class="text-center">
    <h1 class="display-4">Calendrier des congés</h1>
</div>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div id="calendar"></div>
        </div>
    </div>
</div>

<!-- Formulaire de demande de congé -->
<div class="modal fade" id="demandeCongeModal" tabindex="-1" role="dialog" aria-labelledby="demandeCongeModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="demandeCongeModalLabel">Nouvelle demande de congé</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="demandeCongeForm" asp-action="Create" asp-controller="DemandesConge" method="post">
                    @Html.AntiForgeryToken()
                    <div class="form-group">
                        <label for="collaborateurId">Collaborateur</label>
                        <select class="form-control" id="collaborateurId" name="CollaborateurId" required>
                            @if (Model.AllCollaborateurs != null && Model.AllCollaborateurs.Any())
                            {
                                // Si l'utilisateur est un collaborateur, pré-sélectionner son nom
                                if (Model.CurrentCollaborateur != null)
                                {
                                    <option value="@Model.CurrentCollaborateur.Id" selected>@Model.CurrentCollaborateur.Nom</option>

                                    // Ajouter les autres collaborateurs
                                    foreach (var collaborateur in Model.AllCollaborateurs)
                                    {
                                        if (collaborateur.Id != Model.CurrentCollaborateur.Id)
                                        {
                                            <option value="@collaborateur.Id">@collaborateur.Nom</option>
                                        }
                                    }
                                }
                                else
                                {
                                    // Si l'utilisateur n'est pas associé à un collaborateur, afficher tous les collaborateurs
                                    foreach (var collaborateur in Model.AllCollaborateurs)
                                    {
                                        <option value="@collaborateur.Id">@collaborateur.Nom</option>
                                    }
                                }
                            }
                            else
                            {
                                <option value="">Aucun collaborateur disponible</option>
                            }
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="dateDebut">Date de début</label>
                        <input type="date" class="form-control" id="dateDebut" name="DateDebut" required>
                    </div>
                    <div class="form-group">
                        <label for="dateFin">Date de fin</label>
                        <input type="date" class="form-control" id="dateFin" name="DateFin" required>
                    </div>
                    <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="submitDemande">Soumettre</button>
            </div>
        </div>
    </div>
</div>

<!-- Bouton pour ouvrir le formulaire de demande -->
<div class="fixed-bottom mb-3 mr-3 text-right">
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#demandeCongeModal">
        Nouvelle demande
    </button>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'fr',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,dayGridWeek,dayGridDay'
                },
                events: [
        @if (Model.DemandesConge != null)
        {
            @foreach (var demande in Model.DemandesConge)
            {
                <text>
                                        {
                                            title: '@demande.Collaborateur.Nom',
                                            start: '@demande.DateDebut.ToString("yyyy-MM-dd")',
                                            end: '@demande.DateFin.AddDays(1).ToString("yyyy-MM-dd")',
                                            color: '@demande.Collaborateur.Couleur',
                                            textColor: '#ffffff'
                                        },
                </text>
            }
        }
        @if (Model.JoursBloques != null)
        {
            @foreach (var jour in Model.JoursBloques)
            {
                <text>
                                        {
                                            title: 'Jour bloqué: @jour.Raison',
                                            start: '@jour.DateBloquee.ToString("yyyy-MM-dd")',
                                            end: '@jour.DateBloquee.AddDays(1).ToString("yyyy-MM-dd")',
                                            color: '#cccccc',
                                            textColor: '#000000'
                                        },
                </text>
            }
        }
                ]
            });
            calendar.render();

            // Gestion du formulaire de demande de congé
            document.getElementById('submitDemande').addEventListener('click', function() {
                var form = document.getElementById('demandeCongeForm');
                var errorMessage = document.getElementById('errorMessage');

                // Afficher les données du formulaire dans la console pour le débogage
                console.log("Données du formulaire:");
                console.log("CollaborateurId: " + document.getElementById('collaborateurId').value);
                console.log("DateDebut: " + document.getElementById('dateDebut').value);
                console.log("DateFin: " + document.getElementById('dateFin').value);

                // Soumettre le formulaire directement
                form.submit();
            });
        });
    </script>
}